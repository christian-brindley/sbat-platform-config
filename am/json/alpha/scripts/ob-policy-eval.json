{
  "name": "Open Banking Dynamic Policy",
  "description": "Open Banking Dynamic Policy",
  "script": "ZnVuY3Rpb24gZ2V0SWRtQ2xpZW50RGV0YWlscygpIHsKICByZXR1cm4geyAKICAgICJpZCI6ICJwb2xpY3ktY2xpZW50IiwKICAgICJzZWNyZXQiOiAicGFzc3dvcmQiLAogICAgImVuZHBvaW50IjogImh0dHA6Ly9hbS9hbS9vYXV0aDIvcmVhbG1zL3Jvb3QvcmVhbG1zL2FscGhhL2FjY2Vzc190b2tlbiIsCiAgICAic2NvcGUiOiAiZnI6aWRtOioiLAogICAgImlkbUFkbWluVXNlcm5hbWUiOiAic2VydmljZV9hY2NvdW50LnBvbGljeSIsCiAgICAiaWRtQWRtaW5QYXNzd29yZCI6ICIwcGVuQmFua2luZyEiCiAgfQp9CgovLyBDb25zdGFudHMKU1RBVFVTX0FVVEhPUklTRUQgPSAiQXV0aG9yaXNlZCIKdmFyIHNjcmlwdF9uYW1lID0gInBvbGljeV9ldmFsdWF0aW9uX3NjcmlwdC5qcyIKbG9nZ2VyLm1lc3NhZ2Uoc2NyaXB0X25hbWUgKyAiOiBzdGFydGluZyIpCgp2YXIgYWNjb3VudHNBbmRUcmFuc2FjdGlvbnNQZXJtaXNzaW9ucyA9IFsKICAgIHtuYW1lOiAiUkVBREFDQ09VTlRTQkFTSUMiLCBwcm9wZXJ0eTogeyBwZXJtaXNzaW9uOiAiUmVhZEFjY291bnRzQmFzaWMiLCByZXF1ZXN0VHlwZTogImFjY291bnRzIn19LAogICAge25hbWU6ICJSRUFEQUNDT1VOVFNERVRBSUwiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkQWNjb3VudHNEZXRhaWwiLCByZXF1ZXN0VHlwZTogImFjY291bnRzIn19LAogICAge25hbWU6ICJSRUFEQkFMQU5DRVMiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkQmFsYW5jZXMiLCByZXF1ZXN0VHlwZTogImJhbGFuY2VzIn19LAogICAge25hbWU6ICJSRUFEQkVORUZJQ0lBUklFU0JBU0lDIiwgcHJvcGVydHk6IHtwZXJtaXNzaW9uOiAiUmVhZEJlbmVmaWNpYXJpZXNCYXNpYyIsIHJlcXVlc3RUeXBlOiAiYmVuZWZpY2lhcmllcyJ9fSwKICAgIHtuYW1lOiAiUkVBREJFTkVGSUNJQVJJRVNERVRBSUwiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkQmVuZWZpY2lhcmllc0RldGFpbCIsIHJlcXVlc3RUeXBlOiAiYmVuZWZpY2lhcmllcyJ9fSwKICAgIHtuYW1lOiAiUkVBRERJUkVDVERFQklUUyIsIHByb3BlcnR5OiB7cGVybWlzc2lvbjogIlJlYWREaXJlY3REZWJpdHMiLCByZXF1ZXN0VHlwZTogImRpcmVjdC1kZWJpdHMifX0sCiAgICB7bmFtZTogIlJFQURPRkZFUlMiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkT2ZmZXJzIiwgcmVxdWVzdFR5cGU6ICJvZmZlcnMifX0sCiAgICB7bmFtZTogIlJFQURQQU4iLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkUEFOIiwgcmVxdWVzdFR5cGU6ICIifX0sCiAgICB7bmFtZTogIlJFQURQQVJUWSIsIHByb3BlcnR5OiB7cGVybWlzc2lvbjogIlJlYWRQYXJ0eSIsIHJlcXVlc3RUeXBlOiAicGFydHkifX0sCiAgICB7bmFtZTogIlJFQURQQVJUSUVTIiwgcHJvcGVydHk6IHtwZXJtaXNzaW9uOiAiUmVhZFBhcnR5IiwgcmVxdWVzdFR5cGU6ICJwYXJ0aWVzIn19LAogICAge25hbWU6ICJSRUFEUEFSVFlQU1UiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkUGFydHlQU1UiLCByZXF1ZXN0VHlwZTogInBhcnR5In19LAogICAge25hbWU6ICJSRUFEUFJPRFVDVCIsIHByb3BlcnR5OiB7cGVybWlzc2lvbjogIlJlYWRQcm9kdWN0cyIsIHJlcXVlc3RUeXBlOiAicHJvZHVjdCJ9fSwKICAgIHtuYW1lOiAiUkVBRFBST0RVQ1RTIiwgcHJvcGVydHk6IHtwZXJtaXNzaW9uOiAiUmVhZFByb2R1Y3RzIiwgcmVxdWVzdFR5cGU6ICJwcm9kdWN0cyJ9fSwKICAgIHtuYW1lOiAiUkVBRFNDSEVEVUxFRFBBWU1FTlRTQkFTSUMiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkU2NoZWR1bGVkUGF5bWVudHNCYXNpYyIsIHJlcXVlc3RUeXBlOiAic2NoZWR1bGVkLXBheW1lbnRzIn19LAogICAge25hbWU6ICJSRUFEU0NIRURVTEVEUEFZTUVOVFNERVRBSUwiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkU2NoZWR1bGVkUGF5bWVudHNEZXRhaWwiLCByZXF1ZXN0VHlwZTogInNjaGVkdWxlZC1wYXltZW50cyJ9fSwKICAgIHtuYW1lOiAiUkVBRFNUQU5ESU5HT1JERVJTQkFTSUMiLHByb3BlcnR5OiB7cGVybWlzc2lvbjogIlJlYWRTdGFuZGluZ09yZGVyc0Jhc2ljIiwgcmVxdWVzdFR5cGU6ICJzdGFuZGluZy1vcmRlcnMifX0sCiAgICB7bmFtZTogIlJFQURTVEFORElOR09SREVSU0RFVEFJTCIscHJvcGVydHk6IHtwZXJtaXNzaW9uOiAiUmVhZFN0YW5kaW5nT3JkZXJzRGV0YWlsIiwgcmVxdWVzdFR5cGU6ICJzdGFuZGluZy1vcmRlcnMifX0sCiAgICB7bmFtZTogIlJFQURTVEFURU1FTlRTQkFTSUMiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkU3RhdGVtZW50c0Jhc2ljIiwgcmVxdWVzdFR5cGU6ICJzdGF0ZW1lbnRzIn19LAogICAge25hbWU6ICJSRUFEU1RBVEVNRU5UU0RFVEFJTCIsIHByb3BlcnR5OiB7cGVybWlzc2lvbjogIlJlYWRTdGF0ZW1lbnRzRGV0YWlsIiwgcmVxdWVzdFR5cGU6ICJzdGF0ZW1lbnRzIn19LAogICAge25hbWU6ICJSRUFEVFJBTlNBQ1RJT05TQkFTSUMiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkVHJhbnNhY3Rpb25zQmFzaWMiLCByZXF1ZXN0VHlwZTogInRyYW5zYWN0aW9ucyJ9fSwKICAgIHtuYW1lOiAiUkVBRFRSQU5TQUNUSU9OU0NSRURJVFMiLCBwcm9wZXJ0eToge3Blcm1pc3Npb246ICJSZWFkVHJhbnNhY3Rpb25zQ3JlZGl0cyIsIHJlcXVlc3RUeXBlOiAidHJhbnNhY3Rpb25zIn19LAogICAge25hbWU6ICJSRUFEVFJBTlNBQ1RJT05TREVCSVRTIiwgcHJvcGVydHk6IHtwZXJtaXNzaW9uOiAiUmVhZFRyYW5zYWN0aW9uc0RlYml0cyIsIHJlcXVlc3RUeXBlOiAidHJhbnNhY3Rpb25zIn19LAogICAge25hbWU6ICJSRUFEVFJBTlNBQ1RJT05TREVUQUlMIiwgcHJvcGVydHk6IHtwZXJtaXNzaW9uOiAiUmVhZFRyYW5zYWN0aW9uc0RldGFpbCIsIHJlcXVlc3RUeXBlOiAidHJhbnNhY3Rpb25zIn19Cl07Cgp2YXIgcGF5bWVudHNJbnRlbnRzID0gWyJkb21lc3RpY1BheW1lbnRJbnRlbnQiLCAiZG9tZXN0aWNTY2hlZHVsZWRQYXltZW50SW50ZW50IiwgImRvbWVzdGljU3RhbmRpbmdPcmRlckludGVudCIsICJpbnRlcm5hdGlvbmFsUGF5bWVudEludGVudCIsICJpbnRlcm5hdGlvbmFsU2NoZWR1bGVkUGF5bWVudEludGVudCJdOwoKZnVuY3Rpb24gZ2V0UGVybWlzc2lvbkFjY291bnRBbmRUcmFuc2FjdGlvbnMobmFtZSkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhY2NvdW50c0FuZFRyYW5zYWN0aW9uc1Blcm1pc3Npb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGFjY291bnRzQW5kVHJhbnNhY3Rpb25zUGVybWlzc2lvbnNbaV0ubmFtZSA9PT0gbmFtZSB8fCBhY2NvdW50c0FuZFRyYW5zYWN0aW9uc1Blcm1pc3Npb25zW2ldLnByb3BlcnR5LnBlcm1pc3Npb24gPT0gbmFtZSkgewogICAgICAgICAgICByZXR1cm4gYWNjb3VudHNBbmRUcmFuc2FjdGlvbnNQZXJtaXNzaW9uc1tpXS5wcm9wZXJ0eS5wZXJtaXNzaW9uCiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGwKfQoKZnVuY3Rpb24gZ2V0UmVxdWVzdFR5cGVBY2NvdW50QW5kVHJhbnNhY3Rpb25zKHJlcXVlc3RUeXBlKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFjY291bnRzQW5kVHJhbnNhY3Rpb25zUGVybWlzc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoYWNjb3VudHNBbmRUcmFuc2FjdGlvbnNQZXJtaXNzaW9uc1tpXS5wcm9wZXJ0eS5yZXF1ZXN0VHlwZSA9PT0gcmVxdWVzdFR5cGUpIHJldHVybiBhY2NvdW50c0FuZFRyYW5zYWN0aW9uc1Blcm1pc3Npb25zW2ldLnByb3BlcnR5LnJlcXVlc3RUeXBlCiAgICB9CiAgICByZXR1cm4gbnVsbAp9CgpmdW5jdGlvbiBkYXRhQXV0aG9yaXNlZEFjY291bnRBbmRUcmFuc2FjdGlvbnMocGVybWlzc2lvbnMsIHJlcXVlc3RUeXBlKSB7CiAgICBzd2l0Y2ggKHJlcXVlc3RUeXBlKSB7CiAgICAgICAgY2FzZSAidHJhbnNhY3Rpb25zIjoKICAgICAgICAgICAgcmV0dXJuICgocGVybWlzc2lvbnMuaW5kZXhPZihnZXRQZXJtaXNzaW9uQWNjb3VudEFuZFRyYW5zYWN0aW9ucygiUkVBRFRSQU5TQUNUSU9OU0JBU0lDIikpID4gLTEgfHwgcGVybWlzc2lvbnMuaW5kZXhPZihnZXRQZXJtaXNzaW9uQWNjb3VudEFuZFRyYW5zYWN0aW9ucygiUkVBRFRSQU5TQUNUSU9OU0RFVEFJTCIpKSA+IC0xKSAmJiAocGVybWlzc2lvbnMuaW5kZXhPZihnZXRQZXJtaXNzaW9uQWNjb3VudEFuZFRyYW5zYWN0aW9ucygiUkVBRFRSQU5TQUNUSU9OU0RFQklUUyIpKSA+IC0xIHx8IHBlcm1pc3Npb25zLmluZGV4T2YoZ2V0UGVybWlzc2lvbkFjY291bnRBbmRUcmFuc2FjdGlvbnMoIlJFQURUUkFOU0FDVElPTlNDUkVESVRTIikpID4gLTEpKQogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYWNjb3VudHNBbmRUcmFuc2FjdGlvbnNQZXJtaXNzaW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHJlcXVlc3RUeXBlID09IGFjY291bnRzQW5kVHJhbnNhY3Rpb25zUGVybWlzc2lvbnNbaV0ucHJvcGVydHkucmVxdWVzdFR5cGUgJiYgcGVybWlzc2lvbnMuaW5kZXhPZihhY2NvdW50c0FuZFRyYW5zYWN0aW9uc1Blcm1pc3Npb25zW2ldLnByb3BlcnR5LnBlcm1pc3Npb24pID4gLTEpIHJldHVybiB0cnVlCiAgICAgICAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZQp9CgpmdW5jdGlvbiBkYXRhQXV0aG9yaXNlZChwZXJtaXNzaW9ucywgcmVxdWVzdFR5cGUpIHsKICAgIGlmIChkYXRhQXV0aG9yaXNlZEFjY291bnRBbmRUcmFuc2FjdGlvbnMocGVybWlzc2lvbnMsIHJlcXVlc3RUeXBlKSkKICAgICAgICByZXR1cm4gdHJ1ZQogICAgcmV0dXJuIGZhbHNlCn0KCmZ1bmN0aW9uIHBhcnNlUmVzb3VyY2VVcmkoKSB7CiAgICB2YXIgZWxlbWVudHMgPSByZXNvdXJjZVVSSS5zcGxpdCgiLyIpOwogICAgcmV0dXJuIHsKICAgICAgICAiYXBpIjogZWxlbWVudHNbNl0uaW5kZXhPZigiPyIpID4gLTEgPyBlbGVtZW50c1s2XS5zdWJzdHJpbmcoMCwgZWxlbWVudHNbNl0uaW5kZXhPZigiPyIpKSA6IGVsZW1lbnRzWzZdLAogICAgICAgICJpZCI6IChlbGVtZW50cy5sZW5ndGggPiA3KSA/IGVsZW1lbnRzWzddIDogbnVsbCwKICAgICAgICAiZGF0YSI6IChlbGVtZW50cy5sZW5ndGggPiA4KSA/IGVsZW1lbnRzWzhdIDogbnVsbAogICAgfQp9Cgp2YXIgcCA9ICI9IjsKdmFyIHRhYiA9ICJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvIjsKCmZ1bmN0aW9uIGJhc2U2NGVuY29kZShiYSkgewogICAgdmFyIHMgPSBbXSwgbCA9IGJhLmxlbmd0aDsKICAgIHZhciBybSA9IGwgJSAzOwogICAgdmFyIHggPSBsIC0gcm07CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHg7KSB7CiAgICAgICAgdmFyIHQgPSBiYVtpKytdIDw8IDE2IHwgYmFbaSsrXSA8PCA4IHwgYmFbaSsrXTsKICAgICAgICBzLnB1c2godGFiLmNoYXJBdCgodCA+Pj4gMTgpICYgMHgzZikpOwogICAgICAgIHMucHVzaCh0YWIuY2hhckF0KCh0ID4+PiAxMikgJiAweDNmKSk7CiAgICAgICAgcy5wdXNoKHRhYi5jaGFyQXQoKHQgPj4+IDYpICYgMHgzZikpOwogICAgICAgIHMucHVzaCh0YWIuY2hhckF0KHQgJiAweDNmKSk7CiAgICB9CiAgICAvLwlkZWFsIHdpdGggdHJhaWxlcnMsIGJhc2VkIG9uIHBhdGNoIGZyb20gUGV0ZXIgV29vZC4KICAgIHN3aXRjaCAocm0pIHsKICAgICAgICBjYXNlIDI6IHsKICAgICAgICAgICAgdmFyIHQgPSBiYVtpKytdIDw8IDE2IHwgYmFbaSsrXSA8PCA4OwogICAgICAgICAgICBzLnB1c2godGFiLmNoYXJBdCgodCA+Pj4gMTgpICYgMHgzZikpOwogICAgICAgICAgICBzLnB1c2godGFiLmNoYXJBdCgodCA+Pj4gMTIpICYgMHgzZikpOwogICAgICAgICAgICBzLnB1c2godGFiLmNoYXJBdCgodCA+Pj4gNikgJiAweDNmKSk7CiAgICAgICAgICAgIHMucHVzaChwKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNhc2UgMTogewogICAgICAgICAgICB2YXIgdCA9IGJhW2krK10gPDwgMTY7CiAgICAgICAgICAgIHMucHVzaCh0YWIuY2hhckF0KCh0ID4+PiAxOCkgJiAweDNmKSk7CiAgICAgICAgICAgIHMucHVzaCh0YWIuY2hhckF0KCh0ID4+PiAxMikgJiAweDNmKSk7CiAgICAgICAgICAgIHMucHVzaChwKTsKICAgICAgICAgICAgcy5wdXNoKHApOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcy5qb2luKCIiKTsJLy8Jc3RyaW5nCn0KCmZ1bmN0aW9uIGJhc2U2NGRlY29kZShzdHIpIHsKICAgIHZhciBzID0gc3RyLnNwbGl0KCIiKSwgb3V0ID0gW107CiAgICB2YXIgbCA9IHMubGVuZ3RoOwogICAgd2hpbGUgKHNbLS1sXSA9PSBwKSB7CiAgICB9CS8vCXN0cmlwIG9mZiB0cmFpbGluZyBwYWRkaW5nCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGw7KSB7CiAgICAgICAgdmFyIHQgPSB0YWIuaW5kZXhPZihzW2krK10pIDw8IDE4OwogICAgICAgIGlmIChpIDw9IGwpIHsKICAgICAgICAgICAgdCB8PSB0YWIuaW5kZXhPZihzW2krK10pIDw8IDEyCiAgICAgICAgfQogICAgICAgIDsKICAgICAgICBpZiAoaSA8PSBsKSB7CiAgICAgICAgICAgIHQgfD0gdGFiLmluZGV4T2Yoc1tpKytdKSA8PCA2CiAgICAgICAgfQogICAgICAgIDsKICAgICAgICBpZiAoaSA8PSBsKSB7CiAgICAgICAgICAgIHQgfD0gdGFiLmluZGV4T2Yoc1tpKytdKQogICAgICAgIH0KICAgICAgICA7CiAgICAgICAgb3V0LnB1c2goKHQgPj4+IDE2KSAmIDB4ZmYpOwogICAgICAgIG91dC5wdXNoKCh0ID4+PiA4KSAmIDB4ZmYpOwogICAgICAgIG91dC5wdXNoKHQgJiAweGZmKTsKICAgIH0KICAgIC8vCXN0cmlwIG9mZiBhbnkgbnVsbCBieXRlcwogICAgd2hpbGUgKG91dFtvdXQubGVuZ3RoIC0gMV0gPT0gMCkgewogICAgICAgIG91dC5wb3AoKTsKICAgIH0KICAgIHJldHVybiBvdXQ7CS8vCWJ5dGVbXQp9CgpmdW5jdGlvbiBzdHJpbmdGcm9tQXJyYXkoZGF0YSkgewogICAgdmFyIGNvdW50ID0gZGF0YS5sZW5ndGg7CiAgICB2YXIgc3RyID0gIiI7CgogICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGNvdW50OyBpbmRleCArPSAxKQogICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRhdGFbaW5kZXhdKTsKCiAgICByZXR1cm4gc3RyOwp9CgpmdW5jdGlvbiBsb2dSZXNwb25zZShjYWxsZXJNZXRob2QsIHJlc3BvbnNlKSB7CiAgICBsb2dnZXIubWVzc2FnZShzY3JpcHRfbmFtZSArICI6IFsiICsgY2FsbGVyTWV0aG9kICsgIl0gT0JfUG9saWN5IFVzZXIgUkVTVCBDYWxsLiBTdGF0dXM6ICIgKyByZXNwb25zZS5nZXRTdGF0dXMoKSArICIsIEJvZHk6ICIgKyByZXNwb25zZS5nZXRFbnRpdHkoKS5nZXRTdHJpbmcoKSk7Cn0KCmZ1bmN0aW9uIGdldElkbUFjY2Vzc1Rva2VuKCkgewoKICAgIHZhciBjbGllbnRJbmZvID0gZ2V0SWRtQ2xpZW50RGV0YWlscygpOwogICAgdmFyIHJlcXVlc3QgPSBuZXcgb3JnLmZvcmdlcm9jay5odHRwLnByb3RvY29sLlJlcXVlc3QoKTsKICAgIHJlcXVlc3Quc2V0VXJpKGNsaWVudEluZm8uZW5kcG9pbnQpOwogICAgcmVxdWVzdC5zZXRNZXRob2QoIlBPU1QiKTsKICAgIHJlcXVlc3QuZ2V0SGVhZGVycygpLmFkZCgiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpOwogICAgdmFyIGZvcm12YXJzID0gImdyYW50X3R5cGU9cGFzc3dvcmQiICsKICAgICAgICAiJmNsaWVudF9pZD0iICsgY2xpZW50SW5mby5pZCArCiAgICAgICAgIiZjbGllbnRfc2VjcmV0PSIgKyBjbGllbnRJbmZvLnNlY3JldCArCiAgICAgICAgIiZzY29wZT0iICsgY2xpZW50SW5mby5zY29wZSArCiAgICAgICAgIiZ1c2VybmFtZT0iICsgY2xpZW50SW5mby5pZG1BZG1pblVzZXJuYW1lICsKICAgICAgICAiJnBhc3N3b3JkPSIgKyBjbGllbnRJbmZvLmlkbUFkbWluUGFzc3dvcmQ7CiAgICByZXF1ZXN0LnNldEVudGl0eShmb3JtdmFycyk7CgogICAgdmFyIHJlc3BvbnNlID0gaHR0cENsaWVudC5zZW5kKHJlcXVlc3QpLmdldCgpOwoKCiAgICBsb2dSZXNwb25zZSgiZ2V0SWRtQWNjZXNzVG9rZW4iLCByZXNwb25zZSk7CgogICAgdmFyIG9hdXRoMnJlc3BvbnNlID0gSlNPTi5wYXJzZShyZXNwb25zZS5nZXRFbnRpdHkoKS5nZXRTdHJpbmcoKSk7CgogICAgdmFyIGFjY2Vzc1Rva2VuID0gb2F1dGgycmVzcG9uc2UuYWNjZXNzX3Rva2VuCiAgICBsb2dnZXIubWVzc2FnZShzY3JpcHRfbmFtZSArICI6IEdvdCBhY2Nlc3MgdG9rZW4gIiArIGFjY2Vzc1Rva2VuKTsKICAgIHJldHVybiBhY2Nlc3NUb2tlbgp9CgpmdW5jdGlvbiBmaW5kSW50ZW50VHlwZShhcGkpIHsKICAgIGlmIChnZXRSZXF1ZXN0VHlwZUFjY291bnRBbmRUcmFuc2FjdGlvbnMoYXBpKSAhPSBudWxsKSB7CiAgICAgICAgcmV0dXJuICJhY2NvdW50QWNjZXNzSW50ZW50IgogICAgfSBlbHNlIGlmIChhcGkgPT09ICJkb21lc3RpYy1wYXltZW50cyIgfHwgYXBpID09PSAiZG9tZXN0aWMtcGF5bWVudC1jb25zZW50cyIpIHsKICAgICAgICByZXR1cm4gImRvbWVzdGljUGF5bWVudEludGVudCIKICAgIH0gZWxzZSBpZiAoYXBpID09PSAiZG9tZXN0aWMtc2NoZWR1bGVkLXBheW1lbnRzIiB8fCBhcGkgPT09ICJkb21lc3RpYy1zY2hlZHVsZWQtcGF5bWVudC1jb25zZW50cyIpIHsKICAgICAgICByZXR1cm4gImRvbWVzdGljU2NoZWR1bGVkUGF5bWVudEludGVudCIKICAgIH0gZWxzZSBpZiAoYXBpID09PSAiZG9tZXN0aWMtc3RhbmRpbmctb3JkZXJzIiB8fCBhcGkgPT09ICJkb21lc3RpYy1zdGFuZGluZy1vcmRlci1jb25zZW50cyIpIHsKICAgICAgICByZXR1cm4gImRvbWVzdGljU3RhbmRpbmdPcmRlckludGVudCIKICAgIH0gZWxzZSBpZiAoYXBpID09PSAiaW50ZXJuYXRpb25hbC1wYXltZW50cyIgfHwgYXBpID09PSAiaW50ZXJuYXRpb25hbC1wYXltZW50LWNvbnNlbnRzIikgewogICAgICAgIHJldHVybiAiaW50ZXJuYXRpb25hbFBheW1lbnRJbnRlbnQiCiAgICB9IGVsc2UgaWYgKGFwaSA9PT0gImludGVybmF0aW9uYWwtc2NoZWR1bGVkLXBheW1lbnRzIiB8fCBhcGkgPT09ICJpbnRlcm5hdGlvbmFsLXNjaGVkdWxlZC1wYXltZW50LWNvbnNlbnRzIikgewogICAgICAgIHJldHVybiAiaW50ZXJuYXRpb25hbFNjaGVkdWxlZFBheW1lbnRJbnRlbnQiCiAgICB9CiAgICByZXR1cm4gbnVsbAp9CgpmdW5jdGlvbiBnZXRJbnRlbnQoaW50ZW50SWQsIGludGVudFR5cGUpIHsKICAgIHZhciBhY2Nlc3NUb2tlbiA9IGdldElkbUFjY2Vzc1Rva2VuKCk7CiAgICB2YXIgcmVxdWVzdCA9IG5ldyBvcmcuZm9yZ2Vyb2NrLmh0dHAucHJvdG9jb2wuUmVxdWVzdCgpOwogICAgdmFyIHVyaSA9ICJodHRwOi8vaWRtL29wZW5pZG0vbWFuYWdlZC8iICsgaW50ZW50VHlwZSArICIvIiArIGludGVudElkICsgIj9fZmllbGRzPV9pZCxfcmV2LERhdGEsUmlzayx1c2VyL19pZCxhY2NvdW50cyxhcGlDbGllbnQvX2lkIgogICAgbG9nZ2VyLm1lc3NhZ2Uoc2NyaXB0X25hbWUgKyAiOiBJRE0gZmV0Y2ggIiArIHVyaSkKCiAgICByZXF1ZXN0LnNldE1ldGhvZCgnR0VUJyk7CiAgICByZXF1ZXN0LnNldFVyaSh1cmkpCiAgICByZXF1ZXN0LmdldEhlYWRlcnMoKS5hZGQoIkF1dGhvcml6YXRpb24iLCAiQmVhcmVyICIgKyBhY2Nlc3NUb2tlbik7CgogICAgdmFyIHJlc3BvbnNlID0gaHR0cENsaWVudC5zZW5kKHJlcXVlc3QpLmdldCgpOwogICAgbG9nUmVzcG9uc2UoImdldEludGVudCIsIHJlc3BvbnNlKTsKCiAgICB2YXIgaW50ZW50ID0gSlNPTi5wYXJzZShyZXNwb25zZS5nZXRFbnRpdHkoKS5nZXRTdHJpbmcoKSk7CiAgICByZXR1cm4gaW50ZW50Cn0KCmZ1bmN0aW9uIGRlZXBDb21wYXJlKGFyZzEsIGFyZzIpIHsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJnMSkgPT09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChhcmcyKSkgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJnMSkgPT09ICdbb2JqZWN0IE9iamVjdF0nIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChhcmcxKSA9PT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoYXJnMSkubGVuZ3RoICE9PSBPYmplY3Qua2V5cyhhcmcyKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKE9iamVjdC5rZXlzKGFyZzEpLmV2ZXJ5KGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWVwQ29tcGFyZShhcmcxW2tleV0sIGFyZzJba2V5XSk7CiAgICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChhcmcxID09PSBhcmcyKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKfQoKCmZ1bmN0aW9uIGluaXRpYXRpb25NYXRjaChpbml0aWF0aW9uUmVxdWVzdCwgaW5pdGlhdGlvbikgewogICAgdmFyIGluaXRpYXRpb25SZXF1ZXN0T2JqID0gSlNPTi5wYXJzZShzdHJpbmdGcm9tQXJyYXkoYmFzZTY0ZGVjb2RlKGluaXRpYXRpb25SZXF1ZXN0KSkpCiAgICBpZiAoaW5pdGlhdGlvbi5EZWJ0b3JBY2NvdW50ICYmIGluaXRpYXRpb24uRGVidG9yQWNjb3VudC5BY2NvdW50SWQpIHsKICAgICAgICBkZWxldGUgaW5pdGlhdGlvbi5EZWJ0b3JBY2NvdW50LkFjY291bnRJZDsKICAgIH0KICAgIGxvZ2dlci5tZXNzYWdlKHNjcmlwdF9uYW1lICsgIjogaW5pdGlhdGlvblJlcXVlc3RPYmogIiArIEpTT04uc3RyaW5naWZ5KGluaXRpYXRpb25SZXF1ZXN0T2JqKSkKICAgIGxvZ2dlci5tZXNzYWdlKHNjcmlwdF9uYW1lICsgIjogaW5pdGlhdGlvbiAiICsgSlNPTi5zdHJpbmdpZnkoaW5pdGlhdGlvbikpCgogICAgdmFyIG1hdGNoID0gZGVlcENvbXBhcmUoaW5pdGlhdGlvblJlcXVlc3RPYmosIGluaXRpYXRpb24pOwogICAgaWYgKCFtYXRjaCkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKHNjcmlwdF9uYW1lICsgIjogTWlzbWF0Y2ggYmV0d2VlbiByZXF1ZXN0IFsiICsgSlNPTi5zdHJpbmdpZnkoaW5pdGlhdGlvblJlcXVlc3RPYmopICsgIl0gYW5kIGNvbnNlbnQgWyIgKyBKU09OLnN0cmluZ2lmeShpbml0aWF0aW9uKSArICJdIik7CiAgICB9CgogICAgcmV0dXJuIG1hdGNoCn0KCnZhciBpbnRlbnRJZCA9IGVudmlyb25tZW50LmdldCgiaW50ZW50X2lkIikuaXRlcmF0b3IoKS5uZXh0KCk7CnZhciBhcGlSZXF1ZXN0ID0gcGFyc2VSZXNvdXJjZVVyaSgpCmxvZ2dlci5tZXNzYWdlKHNjcmlwdF9uYW1lICsgIjogcmVxICIgKyBhcGlSZXF1ZXN0LmFwaSArICI6IiArIGFwaVJlcXVlc3QuaWQgKyAiOiIgKyBhcGlSZXF1ZXN0LmRhdGEpOwoKdmFyIGludGVudFR5cGUgPSBmaW5kSW50ZW50VHlwZShhcGlSZXF1ZXN0LmFwaSkKdmFyIGludGVudCA9IGdldEludGVudChpbnRlbnRJZCwgaW50ZW50VHlwZSk7CgppZiAoaW50ZW50VHlwZSA9PT0gImFjY291bnRBY2Nlc3NJbnRlbnQiKSB7CiAgICBsb2dnZXIubWVzc2FnZShzY3JpcHRfbmFtZSArICI6IEFjY291bnQgQWNjZXNzIEludGVudCIpOwoKICAgIHZhciBzdGF0dXMgPSBpbnRlbnQuRGF0YS5TdGF0dXMKICAgIHZhciBwZXJtaXNzaW9ucyA9IGludGVudC5EYXRhLlBlcm1pc3Npb25zCiAgICB2YXIgYWNjb3VudHMgPSBpbnRlbnQuYWNjb3VudHMKICAgIC8vIFRoZSByZXNwb25zZUF0dHJpYnV0ZXMgZXhwZWN0ZWQgYWx3YXlzIGFuZCBhcnJheSBhcyB2YWx1ZQogICAgdmFyIHVzZXJSZXNvdXJjZU93bmVyID0gbmV3IEFycmF5KGludGVudC51c2VyLl9pZCkKCiAgICBpZiAoc3RhdHVzICE9IFNUQVRVU19BVVRIT1JJU0VEKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2Uoc2NyaXB0X25hbWUgKyAiLVtBY2NvdW50IEFjY2Vzc106IFJlamVjdGluZyByZXF1ZXN0IC0gc3RhdHVzIFsiICsgc3RhdHVzICsgIl0iKQogICAgICAgIGF1dGhvcml6ZWQgPSBmYWxzZQogICAgfSBlbHNlIGlmIChhcGlSZXF1ZXN0LmlkID09IG51bGwpIHsKICAgICAgICBsb2dnZXIubWVzc2FnZShzY3JpcHRfbmFtZSArICItW0FjY291bnQgQWNjZXNzXTogYWNjb3VudHMgIiArIGFjY291bnRzKTsKICAgICAgICByZXNwb25zZUF0dHJpYnV0ZXMucHV0KCJncmFudGVkQWNjb3VudHMiLCBhY2NvdW50cyk7CiAgICAgICAgcmVzcG9uc2VBdHRyaWJ1dGVzLnB1dCgiZ3JhbnRlZFBlcm1pc3Npb25zIiwgcGVybWlzc2lvbnMpOwogICAgICAgIHJlc3BvbnNlQXR0cmlidXRlcy5wdXQoInVzZXJSZXNvdXJjZU93bmVyIiwgdXNlclJlc291cmNlT3duZXIpOwogICAgICAgIGF1dGhvcml6ZWQgPSB0cnVlCiAgICB9IGVsc2UgaWYgKGFwaVJlcXVlc3QuZGF0YSA9PSBudWxsKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2Uoc2NyaXB0X25hbWUgKyAiLVtBY2NvdW50IEFjY2Vzc106IGFjY291bnQgaW5mbyBmb3IgIiArIGFwaVJlcXVlc3QuaWQpOwogICAgICAgIC8vIFJTIHNlcnZlciBleHBlY3RzIGdyYW50ZWQgYWNjb3VudHMgYW5kIHBlcm1pc3Npb25zIGV2ZW4gdGhvdWdoIHdlJ3JlIGNoZWNraW5nIGFzIHdlbGwKICAgICAgICByZXNwb25zZUF0dHJpYnV0ZXMucHV0KCJncmFudGVkQWNjb3VudHMiLCBhY2NvdW50cyk7CiAgICAgICAgcmVzcG9uc2VBdHRyaWJ1dGVzLnB1dCgiZ3JhbnRlZFBlcm1pc3Npb25zIiwgcGVybWlzc2lvbnMpOwogICAgICAgIHJlc3BvbnNlQXR0cmlidXRlcy5wdXQoInVzZXJSZXNvdXJjZU93bmVyIiwgdXNlclJlc291cmNlT3duZXIpOwogICAgICAgIGF1dGhvcml6ZWQgPSAoYWNjb3VudHMuaW5kZXhPZihhcGlSZXF1ZXN0LmlkKSA+IC0xKSAmJgogICAgICAgICAgICBkYXRhQXV0aG9yaXNlZChwZXJtaXNzaW9ucywgYXBpUmVxdWVzdC5hcGkpCiAgICB9IGVsc2UgewogICAgICAgIGxvZ2dlci5tZXNzYWdlKHNjcmlwdF9uYW1lICsgIi1bQWNjb3VudCBBY2Nlc3NdOiBhY2NvdW50IHJlcXVlc3QgZm9yICIgKyBhcGlSZXF1ZXN0LmlkICsgIjoiICsgYXBpUmVxdWVzdC5kYXRhKTsKICAgICAgICAvLyBSUyBzZXJ2ZXIgZXhwZWN0cyBncmFudGVkIGFjY291bnRzIGFuZCBwZXJtaXNzaW9ucyBldmVuIHRob3VnaCB3ZSdyZSBjaGVja2luZyBhcyB3ZWxsCiAgICAgICAgcmVzcG9uc2VBdHRyaWJ1dGVzLnB1dCgiZ3JhbnRlZEFjY291bnRzIiwgYWNjb3VudHMpOwogICAgICAgIHJlc3BvbnNlQXR0cmlidXRlcy5wdXQoImdyYW50ZWRQZXJtaXNzaW9ucyIsIHBlcm1pc3Npb25zKTsKICAgICAgICByZXNwb25zZUF0dHJpYnV0ZXMucHV0KCJ1c2VyUmVzb3VyY2VPd25lciIsIHVzZXJSZXNvdXJjZU93bmVyKTsKICAgICAgICBhdXRob3JpemVkID0gKGFjY291bnRzLmluZGV4T2YoYXBpUmVxdWVzdC5pZCkgPiAtMSkgJiYKICAgICAgICAgICAgZGF0YUF1dGhvcmlzZWQocGVybWlzc2lvbnMsIGFwaVJlcXVlc3QuZGF0YSkKICAgIH0KCn0gZWxzZSBpZiAocGF5bWVudHNJbnRlbnRzLmluZGV4T2YoaW50ZW50VHlwZSkgIT09IC0xKSB7CiAgICBsb2dnZXIubWVzc2FnZShzY3JpcHRfbmFtZSArICI6IFBheW1lbnRzIEludGVudCIpOwoKICAgIHZhciBzdGF0dXMgPSBpbnRlbnQuRGF0YS5TdGF0dXMKICAgIHZhciB1c2VyUmVzb3VyY2VPd25lciA9IG5ldyBBcnJheShpbnRlbnQudXNlci5faWQpCgogICAgaWYgKHN0YXR1cyAhPT0gU1RBVFVTX0FVVEhPUklTRUQpIHsKICAgICAgICBsb2dnZXIubWVzc2FnZShzY3JpcHRfbmFtZSArICItW1BheW1lbnRzXTogUmVqZWN0aW5nIHJlcXVlc3QgLSBzdGF0dXMgWyIgKyBzdGF0dXMgKyAiXSIpCiAgICAgICAgYXV0aG9yaXplZCA9IGZhbHNlCiAgICB9IGVsc2UgewogICAgICAgIHJlc3BvbnNlQXR0cmlidXRlcy5wdXQoInVzZXJSZXNvdXJjZU93bmVyIiwgdXNlclJlc291cmNlT3duZXIpOwogICAgICAgIHZhciByZXF1ZXN0TWV0aG9kID0gZW52aXJvbm1lbnQuZ2V0KCJyZXF1ZXN0X21ldGhvZCIpLml0ZXJhdG9yKCkubmV4dCgpCgogICAgICAgIGlmIChyZXF1ZXN0TWV0aG9kICE9IG51bGwpIHsKICAgICAgICAgICAgc3dpdGNoIChyZXF1ZXN0TWV0aG9kKSB7CiAgICAgICAgICAgICAgICBjYXNlICJQT1NUIjoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIubWVzc2FnZShzY3JpcHRfbmFtZSArICItW1BheW1lbnRzXTogUE9TVCByZXF1ZXN0Iik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluaXRpYXRpb24gPSBlbnZpcm9ubWVudC5nZXQoImluaXRpYXRpb24iKS5pdGVyYXRvcigpLm5leHQoKQogICAgICAgICAgICAgICAgICAgIGF1dGhvcml6ZWQgPSBpbml0aWF0aW9uTWF0Y2goaW5pdGlhdGlvbiwgaW50ZW50LkRhdGEuSW5pdGlhdGlvbikKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgIkdFVCI6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLm1lc3NhZ2Uoc2NyaXB0X25hbWUgKyAiLVtQYXltZW50c106IEdFVCByZXF1ZXN0Iik7CiAgICAgICAgICAgICAgICAgICAgYXV0aG9yaXplZCA9IHRydWUKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgYXV0aG9yaXplZCA9IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhdXRob3JpemVkID0gZmFsc2UKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICBhdXRob3JpemVkID0gZmFsc2UKfQpsb2dnZXIubWVzc2FnZShzY3JpcHRfbmFtZSArICI6IFBvbGljeSBldmFsdWF0aW9uIHJlc3VsdCwgYXV0aG9yaXplZD0iICsgYXV0aG9yaXplZCk7",
  "default": false,
  "language": "JAVASCRIPT",
  "context": "POLICY_CONDITION"
}
